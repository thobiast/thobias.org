<html>
<head>
<title>~\Desktop\Pessoal\thobias.org\TSMmonitor\pagina\tsmmonitor.html</title>
<meta name="Generator" content="Vim/7.0">
<meta http-equiv="content-type" content="text/html; charset=iso-8859-1">
</head>
<body bgcolor="#ffffff" text="#000000">
<pre>
<font color="#0000ff">#!/bin/sh</font>
<font color="#0000ff"># tsmmonitor - IBM TSM (Tivoli Storage Manager) monitoring script</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Homepage: <a href="http://thobias.org/tsm">http://thobias.org/tsm</a></font>
<font color="#0000ff"># Author  : Thobias Salazar Trevisan (thobias at thobias.org)</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Changelog (DD/MM/YYYY):</font>
<font color="#0000ff"># 28/11/2008 - version 2.0</font>
<font color="#0000ff">#              the source code was rewritten.</font>
<font color="#0000ff">#              there were changes on the command line options, so version 2.0</font>
<font color="#0000ff">#              BREAKS BACKWARDS COMPATIBILITY.</font>
<font color="#0000ff"># 15/06/2007 - first version</font>
<font color="#0000ff">#</font>
<font color="#0000ff">##############################################################################</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># DOCUMENTATION</font>
<font color="#0000ff"># =============</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   This script is developed to provide an easy, customizable and effective</font>
<font color="#0000ff">#   way to monitor TSM Servers.</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   It is composed of functions to check specific TSM resources.</font>
<font color="#0000ff">#   Each check returns the resource status. The available status for a</font>
<font color="#0000ff">#   resource are:</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#         Ok / Warning / Critical</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   The status returned is based on defined thresholds for each check.</font>
<font color="#0000ff">#   For example, the function to check the TSM Database utilization:</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        prompt&gt; ./tsmmonitor db -h</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        check tsm database utilization</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        The default percentages are:</font>
<font color="#0000ff">#           warning..: 85</font>
<font color="#0000ff">#           critical.: 90</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        Usage..: tsmmonitor db [warning] [critical]</font>
<font color="#0000ff">#        Example: tsmmonitor db</font>
<font color="#0000ff">#                 tsmmonitor db 80 95</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   The status returned from db check depends on the warning and critical</font>
<font color="#0000ff">#   threshold values. These values can be customized using command line</font>
<font color="#0000ff">#   arguments:</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        prompt&gt; ./tsmmonitor db</font>
<font color="#0000ff">#        db: database utilization 81%, OK</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        prompt&gt; ./tsmmonitor db 80 90</font>
<font color="#0000ff">#        db: database utilization 81%, Warning</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#        prompt&gt; ./tsmmonitor db 60 80</font>
<font color="#0000ff">#        db: database utilization 81%, Critical</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   Some nice features:</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     * Supports multiples tsm servers (servername)</font>
<font color="#0000ff">#     * Can be used transparently as a nagios plugin</font>
<font color="#0000ff">#     * Alert notification mechanism (by e-mail)</font>
<font color="#0000ff">#     * Customizable threshold values for ok/warning/critical status in command line</font>
<font color="#0000ff">#     * Bourne shell (sh) compliance</font>
<font color="#0000ff">#     * Easy to add news checks </font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   This script should work fine under most *NIX variants. It has been tested</font>
<font color="#0000ff">#   successfully under many Linux and AIX (4.3, 5.2 and 5.3). If you have any</font>
<font color="#0000ff">#   problem, please let me know. </font>
<font color="#0000ff">#</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Nagios</font>
<font color="#0000ff"># ======</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   TSMmonitor can be used transparently as nagios plugin. Nagios plugins</font>
<font color="#0000ff">#   are based on check return code: </font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     0 - normal</font>
<font color="#0000ff">#     1 - warning</font>
<font color="#0000ff">#     2 - critical</font>
<font color="#0000ff">#     3 - unknown</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   These are the same return codes used by tsmmonitor.</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># TSMmonitor Help</font>
<font color="#0000ff"># ===============</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   $ ./tsmmonitor -h</font>
<font color="#0000ff">#   Usage: tsmmonitor [options] [check] [options_check]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   These are global options. They can be used in all checks.</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   -u, --user          tsm user to connect to the tsm server</font>
<font color="#0000ff">#   -p, --pass          tsm user password to connect to the tsm server</font>
<font color="#0000ff">#   -s, --servername    specify tsm servername</font>
<font color="#0000ff">#   -m, --mail          mail addresses separated by blank space</font>
<font color="#0000ff">#   -q, --quiet         quiet mode, suppress all output (except errors)</font>
<font color="#0000ff">#   -S, --source        print the check source code</font>
<font color="#0000ff">#   -h, --help          print this help information and exit</font>
<font color="#0000ff">#   -V, --version       print program version and exit</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   The following checks are available:</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   help, db, log, scratch, drive, path, dbfrag, unav, stgpool, volerr, </font>
<font color="#0000ff">#   volreclaim, tapeslib, tapesown, tapesstgpool, dbbkp, numsess, numnodes,</font>
<font color="#0000ff">#   nodeslocked, diskvol, dbvol, searchanr, drmvol, lic</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   Try 'tsmmonitor &lt;check&gt; --help' for more information.</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   Example:</font>
<font color="#0000ff">#       tsmmonitor db --help</font>
<font color="#0000ff">#       tsmmonitor db</font>
<font color="#0000ff">#       tsmmonitor -m='user1@somewhere.com user2@somewhere.com' db</font>
<font color="#0000ff">#       tsmmonitor --servername=tsmsrv01 db</font>
<font color="#0000ff">#       tsmmonitor --servername=tsmsrv02 db 85 95</font>
<font color="#0000ff">#       tsmmonitor -u=user1 -p=xxx -s=tsmsrv02 db 85 95</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Check Example</font>
<font color="#0000ff"># =============</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   Here is an example of using this script to check tsm db utilization:</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     prompt&gt; ./tsmmonitor db -h</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     check tsm database utilization</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     The default percentages are:</font>
<font color="#0000ff">#        warning..: 85</font>
<font color="#0000ff">#        critical.: 90</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     Usage..: tsmmonitor db [warning] [critical]</font>
<font color="#0000ff">#     Example: tsmmonitor db</font>
<font color="#0000ff">#              tsmmonitor db 80 95</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     prompt&gt; ./tsmmonitor -u=user1 -p=my_pass -s=tsmsrv02 db</font>
<font color="#0000ff">#     db - tsmserver tsmsrv02: database utilization 81%, OK</font>
<font color="#0000ff">#     prompt&gt; echo $?</font>
<font color="#0000ff">#     0</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     prompt&gt; ./tsmmonitor -u=user1 -p=my_pass -s=tsmsrv02 db 80 90</font>
<font color="#0000ff">#     db - tsmserver tsmsrv02: database utilization 81%, Warning</font>
<font color="#0000ff">#     prompt&gt; echo $?</font>
<font color="#0000ff">#     1</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#     prompt&gt; ./tsmmonitor -u=user1 -p=my_pass -s=tsmsrv02 db 60 80</font>
<font color="#0000ff">#     db - tsmserver tsmsrv02: database utilization 81%, Critical</font>
<font color="#0000ff">#     prompt&gt; echo $?</font>
<font color="#0000ff">#     2</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#</font>
<font color="#0000ff">##############################################################################</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#                       Configuration Area</font>
<font color="#0000ff">#                       ==================</font>

<font color="#0000ff">###################################</font>
<font color="#0000ff">########## tsm server information #</font>
<font color="#0000ff">###################################</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># dsmadmc command path</font>
<font color="#008080">DSMADMC</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">/usr/bin/dsmadmc</font><font color="#804040"><b>'</b></font>

<font color="#0000ff"># tsm user</font>
<font color="#008080">USER</font>=<font color="#804040"><b>''</b></font>

<font color="#0000ff"># tsm user password</font>
<font color="#008080">PASS</font>=<font color="#804040"><b>''</b></font>

<font color="#0000ff"># dsm error log</font>
<font color="#0000ff">#DSM_LOG=/home/nagios</font>
<font color="#0000ff">#export DSM_LOG</font>

<font color="#0000ff">##############################</font>
<font color="#0000ff">########## send notification #</font>
<font color="#0000ff">##############################</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># at every time that a check changes the status,</font>
<font color="#0000ff"># an alert (notification) will be sent by mail. default is off</font>
<font color="#008080">SEND_ALERT</font>=<font color="#ff00ff">0</font>

<font color="#0000ff"># e-mails which will receive the notifications. mail addresses are separated</font>
<font color="#0000ff"># by blank space. ex: MAILTO='xxx@yyy.zzz aaa@bbb.zzz ppp@qqq.lll'</font>
<font color="#008080">MAILTO</font>=<font color="#804040"><b>''</b></font>

<font color="#0000ff"># temp directory where tsmmonitor will record check status.</font>
<font color="#0000ff"># it is necessary to send mail when the check status changes</font>
<font color="#008080">TEMPDIR</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">/tmp</font><font color="#804040"><b>'</b></font>

<font color="#0000ff">########################</font>
<font color="#0000ff">########## other flags #</font>
<font color="#0000ff">########################</font>
<font color="#0000ff">#</font>
<font color="#008080">DEBUG</font>=<font color="#ff00ff">0</font>             <font color="#0000ff"># do not edit here, please use --debug</font>
<font color="#008080">COLOR_DEBUG</font>=<font color="#ff00ff">1</font>       <font color="#0000ff"># show debug messages in colors?</font>
<font color="#008080">QUIET</font>=<font color="#ff00ff">0</font>             <font color="#0000ff"># do not edit here, please use --quiet</font>
<font color="#008080">SHOW_CHECK_SOURCE</font>=<font color="#ff00ff">0</font> <font color="#0000ff"># do not edit here, please use --source</font>

<font color="#0000ff">################################</font>
<font color="#0000ff">########## program information #</font>
<font color="#0000ff">################################</font>
<font color="#0000ff">#</font>
<font color="#008080">URL</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff"><a href="http://thobias.org/tsm">http://thobias.org/tsm</a></font><font color="#804040"><b>'</b></font>
<font color="#008080">VERSION</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">2.0</font><font color="#804040"><b>'</b></font>

<font color="#0000ff">#####################################################################</font>
<font color="#0000ff">########## default check threshold                                  #</font>
<font color="#0000ff">########## used to determine the check status (ok/warning/critical) #</font>
<font color="#0000ff">##########                                                          #</font>
<font color="#0000ff">########## These values can be changed through command line options #</font>
<font color="#0000ff">########## prompt&gt; tsmmonitor &lt;check&gt; --help                        #</font>
<font color="#0000ff">#####################################################################</font>
<font color="#0000ff"># check: database utilization</font>
<font color="#008080">DB_WARNING</font>=<font color="#ff00ff">85</font>
<font color="#008080">DB_CRITICAL</font>=<font color="#ff00ff">90</font>
<font color="#0000ff"># check: log utilization</font>
<font color="#008080">LOG_WARNING</font>=<font color="#ff00ff">60</font>
<font color="#008080">LOG_CRITICAL</font>=<font color="#ff00ff">80</font>
<font color="#0000ff"># check: scratch tape number</font>
<font color="#008080">SC_WARNING</font>=<font color="#ff00ff">10</font>
<font color="#008080">SC_CRITICAL</font>=<font color="#ff00ff">6</font>
<font color="#0000ff"># check: number of paths not online</font>
<font color="#008080">PATH_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">PATH_CRITICAL</font>=<font color="#ff00ff">3</font>
<font color="#0000ff"># check: number of drives not online</font>
<font color="#008080">DRIVE_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">DRIVE_CRITICAL</font>=<font color="#ff00ff">3</font>
<font color="#0000ff"># check tsm database fragmantation</font>
<font color="#008080">DBFRAG_WARNING</font>=<font color="#ff00ff">60</font>
<font color="#008080">DBFRAG_CRITICAL</font>=<font color="#ff00ff">80</font>
<font color="#0000ff"># check: number of unavailable volumes</font>
<font color="#008080">UNAV_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">UNAV_CRITICAL</font>=<font color="#ff00ff">5</font>
<font color="#0000ff"># check: storage pool utilization</font>
<font color="#008080">STGPOOL_WARNING</font>=<font color="#ff00ff">80</font>
<font color="#008080">STGPOOL_CRITICAL</font>=<font color="#ff00ff">95</font>
<font color="#0000ff"># check: number of volumes with error</font>
<font color="#008080">VOLERR_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">VOLERR_CRITICAL</font>=<font color="#ff00ff">5</font>
<font color="#0000ff"># check: number of volumes with pct reclaim greather than XX</font>
<font color="#008080">VOLRECL_WARNING</font>=<font color="#ff00ff">5</font>
<font color="#008080">VOLRECL_CRITICAL</font>=<font color="#ff00ff">20</font>
<font color="#0000ff"># check: number of tapes in the library</font>
<font color="#008080">TAPESLIB_WARNING</font>=<font color="#ff00ff">90</font>
<font color="#008080">TAPESLIB_CRITICAL</font>=<font color="#ff00ff">86</font>
<font color="#0000ff"># check: number of tapes with a specific owner</font>
<font color="#008080">TAPESOWN_WARNING</font>=<font color="#ff00ff">2</font>
<font color="#008080">TAPESOWN_CRITICAL</font>=<font color="#ff00ff">3</font>
<font color="#0000ff"># check: number of tapes in a specific storage pool</font>
<font color="#008080">TAPESSTGPOOL_WARNING</font>=<font color="#ff00ff">40</font>
<font color="#008080">TAPESSTGPOOL_CRITICAL</font>=<font color="#ff00ff">50</font>
<font color="#0000ff"># check: number of tsm db backup in the last 24 hours</font>
<font color="#008080">DBBKP_WARNING</font>=<font color="#ff00ff">0</font>
<font color="#008080">DBBKP_CRITICAL</font>=<font color="#ff00ff">0</font>
<font color="#0000ff"># check:  number of nodes session</font>
<font color="#008080">NUMSESS_WARNING</font>=<font color="#ff00ff">15</font>
<font color="#008080">NUMSESS_CRITICAL</font>=<font color="#ff00ff">20</font>
<font color="#0000ff"># check: number of nodes locked</font>
<font color="#008080">NUMNODESLOCKED_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">NUMNODESLOCKED_CRITICAL</font>=<font color="#ff00ff">4</font>
<font color="#0000ff"># check: number of nodes</font>
<font color="#008080">NUMNODES_WARNING</font>=<font color="#ff00ff">80</font>
<font color="#008080">NUMNODES_CRITICAL</font>=<font color="#ff00ff">90</font>
<font color="#0000ff"># check: search for an specific ANR in actlog</font>
<font color="#008080">SEARCHANR_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">SEARCHANR_CRITICAL</font>=<font color="#ff00ff">3</font>
<font color="#0000ff"># Check: number of disk volumes without readwrite access</font>
<font color="#008080">DISKVOL_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">DISKVOL_CRITICAL</font>=<font color="#ff00ff">4</font>
<font color="#0000ff"># Check: number of drm volumes with state different from mountable</font>
<font color="#008080">DRMVOL_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">DRMVOL_CRITICAL</font>=<font color="#ff00ff">4</font>
<font color="#0000ff"># Check: number of database volumes not synchronized</font>
<font color="#008080">DBVOL_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">DBVOL_CRITICAL</font>=<font color="#ff00ff">2</font>
<font color="#0000ff"># Check: number of log volumes not synchronized</font>
<font color="#008080">LOGVOL_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">LOGVOL_CRITICAL</font>=<font color="#ff00ff">2</font>
<font color="#0000ff"># Check number of schedules not completed</font>
<font color="#008080">SCHED_WARNING</font>=<font color="#ff00ff">1</font>
<font color="#008080">SCHED_CRITICAL</font>=<font color="#ff00ff">3</font>

<font color="#0000ff">##############################################################################</font>

<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># #### This section has some functions. These are for internal use only</font>
<font color="#0000ff"># #### not for users</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>

<font color="#0000ff"># Mini tools </font>
_tsmmonitor_tool <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        program_help <font color="#804040"><b>)</b></font>
            cat - <font color="#804040"><b>&lt;&lt;-END</b></font><font color="#ff00ff"> </font>
<font color="#ff00ff">                Usage: tsmmonitor [options] [check] [options_check]</font>

<font color="#ff00ff">                Options</font>

<font color="#ff00ff">                -u, --user          tsm user to connect to the tsm server</font>
<font color="#ff00ff">                -p, --pass          tsm user password to connect to the tsm server</font>
<font color="#ff00ff">                -s, --servername    specify tsm servername</font>
<font color="#ff00ff">                -m, --mail          mail addresses separated by blank space</font>
<font color="#ff00ff">                -q, --quiet         quiet mode, suppress all output (except errors)</font>
<font color="#ff00ff">                -S, --source        print the check source code</font>
<font color="#ff00ff">                -h, --help          print this help information and exit</font>
<font color="#ff00ff">                -V, --version       print program version and exit</font>

<font color="#ff00ff">                The following checks are available:</font>

<font color="#ff00ff">                </font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool list_checks</font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

<font color="#ff00ff">                Try 'tsmmonitor &lt;check&gt; --help' for more information.</font>

<font color="#ff00ff">                Example:</font>
<font color="#ff00ff">                    tsmmonitor db --help</font>
<font color="#ff00ff">                    tsmmonitor db</font>
<font color="#ff00ff">                    tsmmonitor -m='user1@somewhere.com user2@somewhere.com' db</font>
<font color="#ff00ff">                    tsmmonitor --servername=tsmsrv01 db</font>
<font color="#ff00ff">                    tsmmonitor --servername=tsmsrv02 db 85 95</font>
<font color="#ff00ff">                    tsmmonitor -u=user1 -p=xxx -s=tsmsrv02 db 85 95</font>

<font color="#804040"><b>            END</b></font>
            <font color="#804040"><b>exit</b></font>
            <font color="#804040"><b>;;</b></font>
        program_version <font color="#804040"><b>)</b></font>
            <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">tsmmonitor version </font><font color="#a020f0">$VERSION</font><font color="#ff00ff"> &lt;</font><font color="#a020f0">$URL</font><font color="#ff00ff">&gt;</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>exit</b></font>
            <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># show available checks</font>
        list_checks <font color="#804040"><b>)</b></font>
                <font color="#0000ff"># sed does the magic reading from the source code to</font>
                <font color="#0000ff"># get the available check list</font>
                cat <font color="#a020f0">$0</font> <font color="#804040"><b>|</b></font>
                    sed -n <font color="#804040"><b>'</b></font><font color="#ff00ff">s/^\([a-zA-Z]\{1,\}\) ()/\1/p</font><font color="#804040"><b>'</b></font> <font color="#804040"><b>|</b></font>
                    sed <font color="#804040"><b>'</b></font><font color="#ff00ff">:a</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">$!N</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">s/\n/, /</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">t a</font><font color="#804040"><b>'</b></font>
            <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># test if the parameters are numbers</font>
        is_number <font color="#804040"><b>)</b></font>
                <font color="#804040"><b>shift</b></font> <font color="#0000ff"># $1 = tool name (is_number)</font>
                <font color="#804040"><b>for</b></font> i <font color="#804040"><b>in</b></font> <font color="#a020f0">$*</font>
                <font color="#804040"><b>do</b></font>
                    <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$i</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>|</b></font> grep -qs <font color="#804040"><b>'</b></font><font color="#ff00ff">^[0-9]\{1,\}$</font><font color="#804040"><b>'</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>return</b></font> <font color="#ff00ff">1</font>
                <font color="#804040"><b>done</b></font>
            <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># send mail, print the tsmmonitor output and exit with the right return code</font>
        myecho <font color="#804040"><b>)</b></font>
                local <font color="#008080">retcode</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">0</font><font color="#804040"><b>&quot;</b></font>
                local <font color="#008080">check</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>

                <font color="#804040"><b>shift</b></font>
                <font color="#804040"><b>shift</b></font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$SERVERNAME</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">SERVERNAME</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> tsmserver </font><font color="#a020f0">${</font><font color="#a020f0">SERVERNAME</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#ff00ff">:</font><font color="#804040"><b>&quot;</b></font>

                <font color="#0000ff"># Send e-mail is enabled?!</font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$SEND_ALERT</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> _SendAlert <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#ff00ff">:</font><font color="#a020f0">$SERVERNAME</font><font color="#804040"><b>&quot;</b></font> <font color="#a020f0">$*</font>

                <font color="#0000ff"># print the check output</font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$QUIET</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">0</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#ff00ff"> -</font><font color="#a020f0">$SERVERNAME</font><font color="#ff00ff"> </font><font color="#a020f0">$*</font><font color="#804040"><b>&quot;</b></font>

                <font color="#0000ff"># Return code depend on check output</font>
                <font color="#0000ff"># ok       = return code 0</font>
                <font color="#0000ff"># warning  = return code 1</font>
                <font color="#0000ff"># critical = return code 2</font>
                <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$*</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>|</b></font> grep -iqs <font color="#804040"><b>'</b></font><font color="#ff00ff">,  *critical</font><font color="#804040"><b>'</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">retcode</font>=<font color="#ff00ff">2</font>
                <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$*</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>|</b></font> grep -iqs <font color="#804040"><b>'</b></font><font color="#ff00ff">,  *warning</font><font color="#804040"><b>'</b></font>  <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">retcode</font>=<font color="#ff00ff">1</font>

                _Debug <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">tsmmonitor return code: </font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font>

                <font color="#0000ff"># exit with correct return code</font>
                <font color="#804040"><b>exit</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># Connect to tsm server and execute the sql statement</font>
        run_select <font color="#804040"><b>)</b></font>
                local temp_output
                local <font color="#008080">check</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
                local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$3</font><font color="#804040"><b>&quot;</b></font>

                <font color="#0000ff"># Connect to tsm server and run the select statement</font>
                <font color="#008080">temp_output</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#a020f0">$TSM_CMD</font><font color="#6a5acd"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

                <font color="#0000ff"># test if dsmamdc was executed without error</font>
                <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$?</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">0</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$?</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">11</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
                <font color="#804040"><b>then</b></font>
                    _Debug <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$temp_output</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&gt;</b></font> /dev/tty
                    <font color="#0000ff"># Check the tsm command return code</font>
                    _tsmmonitor_tool check_retcode <font color="#a020f0">$check</font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$temp_output</font><font color="#804040"><b>&quot;</b></font>
                    <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$temp_output</font><font color="#804040"><b>&quot;</b></font>
                <font color="#804040"><b>else</b></font>
                    _Debug <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$temp_output</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&gt;</b></font> /dev/tty
                    <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error executing the command dsmadmc</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&gt;</b></font> /dev/tty
                    <font color="#804040"><b>echo</b></font>
                    <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$temp_output</font><font color="#804040"><b>&quot;</b></font>
                    <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
                <font color="#804040"><b>fi</b></font>
            <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># check if the tsm command ran without errors</font>
        check_retcode <font color="#804040"><b>)</b></font>
                local retcode
                local <font color="#008080">check</font>=<font color="#a020f0">$2</font>

                <font color="#804040"><b>shift</b></font>
                <font color="#804040"><b>shift</b></font>
                <font color="#0000ff"># search the tsm command return code</font>
                <font color="#008080">retcode</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">                    sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/.*ighest return code was *\([0-9]*\)\./\1/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

                <font color="#0000ff"># Return code zero</font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">0</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>
                <font color="#0000ff"># Known return code different from 0 that it's not an error</font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">11</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-a</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">req</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">11</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-a</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">numnodes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">11</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-a</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">unav</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">11</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-a</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">volerr</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">11</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-a</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">diskvol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>

                <font color="#0000ff"># if we get here, there was a error at tsm command execution</font>

                <font color="#0000ff"># print the error</font>
                <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Check </font><font color="#a020f0">$check</font><font color="#ff00ff"> error: return code </font><font color="#a020f0">$retcode</font><font color="#804040"><b>&quot;</b></font>

                _Debug <font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> egrep </font><font color="#804040"><b>'</b></font><font color="#ff00ff">^AN</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font>

                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$SEND_ALERT</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> _SendAlert <font color="#a020f0">$check</font> unknown <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">error</font><font color="#804040"><b>&quot;</b></font>

                <font color="#0000ff"># Nagios return code: unknown error</font>
                <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
            <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># print the check (function) source code</font>
        mysource <font color="#804040"><b>)</b></font>
                sed -n <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">/^</font><font color="#a020f0">$2</font><font color="#ff00ff"> </font><font color="#6a5acd">\(\)</font><font color="#ff00ff">/,/^} *$/p</font><font color="#804040"><b>&quot;</b></font> <font color="#a020f0">$0</font>
                <font color="#804040"><b>exit</b></font>
        <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># there is no default tool</font>
    <font color="#804040"><b>esac</b></font>
<font color="#6a5acd">}</font>

<font color="#0000ff"># debug function</font>
_Debug <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#0000ff"># return if debug is disabled</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$DEBUG</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>!=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>

    local <font color="#008080">prefix</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">---- DEBUG</font><font color="#804040"><b>&quot;</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$COLOR_DEBUG</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#0000ff"># INFO: some OS, like AIX there is no echo -e option</font>
        <font color="#0000ff"># so, maybe you may have to remove it</font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> -e </font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd">\033</font><font color="#ff00ff">[32;1m </font><font color="#a020f0">$prefix</font><font color="#ff00ff"> </font><font color="#a020f0">$*</font><font color="#ff00ff"> </font><font color="#6a5acd">\033</font><font color="#ff00ff">[m</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>else</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$prefix</font><font color="#ff00ff"> </font><font color="#a020f0">$*</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>
<font color="#6a5acd">}</font>

<font color="#0000ff"># show the functions help</font>
_ShowHelp <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    local help critical warning
    <font color="#0000ff"># the help is the comments above the function (check) code</font>
    <font color="#0000ff"># this sed gets those lines</font>
    <font color="#0000ff"># $2 = check</font>
    <font color="#008080">help</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">sed -n </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">/^$/{</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">x</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">s/.*//</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">x</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">b</font>
<font color="#6a5acd">                    </font><font color="#ff00ff">}</font>
<font color="#6a5acd">                </font><font color="#ff00ff">/^</font><font color="#a020f0">$2</font><font color="#ff00ff"> ()/{</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">x</font>
<font color="#6a5acd">                        </font><font color="#ff00ff">p</font>
<font color="#6a5acd">                    </font><font color="#ff00ff">}</font>
<font color="#6a5acd">                </font><font color="#ff00ff">H</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#a020f0">$0</font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">            sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^# --/d</font>
<font color="#6a5acd">                    </font><font color="#ff00ff">s/^# \{0,1\}//p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># get the variable name that have the critical threshold for the check</font>
    <font color="#008080">critical</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$help</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">                sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/.*critical\.: *\([^ ]*\).*/\1/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># get the variable name that have the warning threshold for the check</font>
    <font color="#008080">warning</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$help</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">                sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/.*warning\.\.: *\([^ ]*\).*/\1/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>
    <font color="#804040"><b>echo</b></font>
    <font color="#0000ff"># this &quot;ugly&quot; code gets the value (threshold) stored in the variable name</font>
    <font color="#0000ff"># so, the help (tsmmonitor check --help) shows the default threshold that</font>
    <font color="#0000ff"># is defined in the source code and not the variable name</font>
    <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$help</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>|</b></font>
        sed <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">s/: *</font><font color="#a020f0">${</font><font color="#a020f0">critical</font><font color="#804040"><b>:-</b></font><span style="background-color: #ff0000"><font color="#ffffff">@@@</font></span><font color="#a020f0">}</font><font color="#ff00ff">/: </font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#804040"><b>eval</b></font><font color="#6a5acd"> echo </font><font color="#6a5acd">\$</font><font color="#a020f0">$critical</font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#ff00ff">/</font>
<font color="#6a5acd">            </font><font color="#ff00ff">s/: *</font><font color="#a020f0">${</font><font color="#a020f0">warning</font><font color="#804040"><b>:-</b></font><span style="background-color: #ff0000"><font color="#ffffff">@@@</font></span><font color="#a020f0">}</font><font color="#ff00ff">/: </font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#804040"><b>eval</b></font><font color="#6a5acd"> echo </font><font color="#6a5acd">\$</font><font color="#a020f0">$warning</font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#ff00ff">/</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>echo</b></font>
<font color="#6a5acd">}</font>

<font color="#0000ff"># if necessary, send an alert (only when there is a check status change)</font>
<font color="#0000ff"># $1 - check name</font>
<font color="#0000ff"># $* - notification message</font>
_SendAlert <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    local logfile oldstatus i
    local <font color="#008080">check</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">newstatus</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$*</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">        sed </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/^[^,]*, *\(OK\)\{0,1\}\(Warning\)\{0,1\}\(Critical\)\{0,1\}.*/\1\2\3/</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>shift</b></font>
    <font color="#008080">logfile</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$TEMPDIR</font><font color="#ff00ff">/</font><font color="#a020f0">$StatusFile</font><font color="#804040"><b>&quot;</b></font>
    _Debug <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Log file: </font><font color="#a020f0">$logfile</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># is It the first time?</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>-f</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$logfile</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>echo</b></font><font color="#ff00ff"> OK </font><font color="#804040"><b>&gt;</b></font> <font color="#a020f0">$logfile</font> <font color="#0000ff"># is It the first time?</font>
    <font color="#0000ff"># Get the current status</font>
    <font color="#008080">oldstatus</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">&lt;</font><font color="#a020f0">$logfile</font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font>
    <font color="#0000ff"># Debug</font>
    _Debug <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">oldstatus = </font><font color="#a020f0">$oldstatus</font><font color="#ff00ff">, newstatus = </font><font color="#a020f0">$newstatus</font><font color="#804040"><b>&quot;</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$oldstatus</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>!=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$newstatus</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#0000ff"># save new status</font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$newstatus</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&gt;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$logfile</font><font color="#804040"><b>&quot;</b></font> <font color="#0000ff"># save new status</font>

        <font color="#0000ff"># do not send OK alert to sched check. this do not make sense?!</font>
        <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$check</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">sched:</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-a</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$newstatus</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#804040"><b>return</b></font>

        _Debug <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Sending notification to </font><font color="#a020f0">$MAILTO</font><font color="#804040"><b>&quot;</b></font>

        <font color="#0000ff"># Send e-mails</font>
        <font color="#804040"><b>for</b></font> i <font color="#804040"><b>in</b></font> <font color="#a020f0">$MAILTO</font>
        <font color="#804040"><b>do</b></font>
            <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">check </font><font color="#a020f0">$check</font><font color="#ff00ff"> </font><font color="#a020f0">$*</font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff"> </font><font color="#804040"><b>|</b></font>
                mail <font color="#804040"><b>-s</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">tsmmonitor: check </font><font color="#a020f0">$check</font><font color="#ff00ff"> </font><font color="#a020f0">$newstatus</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$i</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>done</b></font>
    <font color="#804040"><b>fi</b></font>
<font color="#6a5acd">}</font>

<font color="#0000ff">##############################################################################</font>

<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># #### yeah tsm checks.</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># show all checks help</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor help</font>
<font color="#0000ff"># Example: tsmmonitor help</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
help <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> help<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local check

    <font color="#0000ff"># for each check, execute tsmmonitor check --help</font>
    <font color="#804040"><b>for</b></font> check <font color="#804040"><b>in</b></font> <span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/^\([a-zA-Z]*\) ().*/\1/p</font><font color="#804040"><b>'</b></font><font color="#6a5acd"> </font><font color="#a020f0">$0</font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>
    <font color="#804040"><b>do</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>'</b></font><font color="#ff00ff">---------------------------------------------------------------------</font><font color="#804040"><b>'</b></font>
        <font color="#a020f0">$0</font> <font color="#a020f0">$check</font> --help <font color="#804040"><b>|</b></font> sed <font color="#804040"><b>'</b></font><font color="#ff00ff">1d;$d</font><font color="#804040"><b>'</b></font>
    <font color="#804040"><b>done</b></font>

    <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>'</b></font><font color="#ff00ff">---------------------------------------------------------------------</font><font color="#804040"><b>'</b></font>
<font color="#6a5acd">}</font>

<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check tsm database utilization</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default percentages are:</font>
<font color="#0000ff">#    warning..: DB_WARNING</font>
<font color="#0000ff">#    critical.: DB_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor db [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor db</font>
<font color="#0000ff">#          tsmmonitor db 80 95</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
db <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> db<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output pct_utl
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT pct_utilized FROM db</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor db: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select db </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">pct_utl</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">                sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/^\([0-9]\{1,\}\)[,.]*[0-9]*$/\1/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># find out the current check status (ok/warning/critical)</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_utl</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DB_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_utl</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DB_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho db <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">database utilization </font><font color="#a020f0">$pct_utl</font><font color="#ff00ff">%, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check tsm recovery log utilization</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default percentages are:</font>
<font color="#0000ff">#    warning..: LOG_WARNING</font>
<font color="#0000ff">#    critical.: LOG_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor log [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor log</font>
<font color="#0000ff">#          tsmmonitor log 80 95</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
log <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> log<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output pct_utl
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT pct_utilized FROM log</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor log: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select log </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">pct_utl</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">                sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/^\([0-9]\{1,\}\)[,.]*[0-9]*$/\1/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_utl</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$LOG_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_utl</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$LOG_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho log <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">log utilization </font><font color="#a020f0">$pct_utl</font><font color="#ff00ff">%, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of scratch tapes</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: SC_WARNING</font>
<font color="#0000ff">#    critical.: SC_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor scratch [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#  -l, --library=LIBRARY_NAME   check for scratch in the library only</font>
<font color="#0000ff"># </font>
<font color="#0000ff"># Example: tsmmonitor scratch</font>
<font color="#0000ff">#          tsmmonitor scratch 8 4</font>
<font color="#0000ff">#          tsmmonitor scratch -l=LTOLIB3 8 4</font>
<font color="#0000ff">#          tsmmonitor scratch -l=LTOLIB3</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
scratch <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> scratch<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_scratch library
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM libvolumes WHERE status='Scratch'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -l=* | --library=* <font color="#804040"><b>)</b></font>
                <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
                <font color="#0000ff"># library is specified, so change the sql statement</font>
                <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND library_name='</font><font color="#a020f0">$library</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
                <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in library </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
                <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor scratch: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select scratch </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">num_scratch</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^ *[0-9]/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_scratch</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-le</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$SC_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_scratch</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-le</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$SC_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho scratch <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of scratch tapes </font><font color="#a020f0">$library$num_scratch</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of drives not online</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: DRIVE_WARNING</font>
<font color="#0000ff">#    critical.: DRIVE_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor drive [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#  -l, --library=LIBRARY_NAME   check in the specific library only</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor drive</font>
<font color="#0000ff">#          tsmmonitor drive 2 3</font>
<font color="#0000ff">#          tsmmonitor drive -l=LTOLIB3 1 2</font>
<font color="#0000ff">#          tsmmonitor drive -l=LTOLIB3</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
drive <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> drive<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_drives library
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM drives WHERE NOT online='YES'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -l=* | --library=* <font color="#804040"><b>)</b></font>
            <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND library_name='</font><font color="#a020f0">$library</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in library </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor drive: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select drive </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">num_drives</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^ *[0-9]/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_drives</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DRIVE_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_drives</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DRIVE_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho drive <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of drives not online </font><font color="#a020f0">$library$num_drives</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of paths not online</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: PATH_WARNING</font>
<font color="#0000ff">#    critical.: PATH_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor path [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># -s, --source=SOURCE_NAME   check path with a specific source name</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor path</font>
<font color="#0000ff">#          tsmmonitor path 2 4</font>
<font color="#0000ff">#          tsmmonitor path -s=LANFREE1 1 4</font>
<font color="#0000ff">#          tsmmonitor path -s=LANFREE1</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
path <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> path<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_paths source
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM paths WHERE NOT online='YES'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -s=* | --source=* <font color="#804040"><b>)</b></font>
            <font color="#008080">source</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND source_name='</font><font color="#a020f0">$source</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">source</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">with source name </font><font color="#a020f0">$source</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor path: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select path </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">num_paths</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^ *[0-9]/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_paths</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$PATH_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_paths</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$PATH_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho path <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of paths not online </font><font color="#a020f0">$source$num_paths</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check tsm database fragmentation</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: DBFRAG_WARNING</font>
<font color="#0000ff">#    critical.: DBFRAG_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor dbfrag [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor dbfrag</font>
<font color="#0000ff">#          tsmmonitor dbfrag 50 75</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
dbfrag <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> dbfrag<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output pct
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT CAST((100 - (CAST(MAX_REDUCTION_MB AS FLOAT) * 256 ) /</font>
<font color="#6a5acd">        </font><font color="#ff00ff">(CAST(USABLE_PAGES AS FLOAT) - CAST(USED_PAGES AS FLOAT) ) * 100) AS</font>
<font color="#6a5acd">        </font><font color="#ff00ff">DECIMAL(4,2)) AS PERCENT_FRAG FROM DB</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor dbfrag: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select dbfrag </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">pct</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9-]/s/[.,].*//p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DBFRAG_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DBFRAG_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho dbfrag <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">database fragmentation </font><font color="#a020f0">$pct</font><font color="#ff00ff">%, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of unavailable volumes</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: UNAV_WARNING</font>
<font color="#0000ff">#    critical.: UNAV_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor unav [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># -d, --deviceclass=DEVICE_CLASS   check only in a specific device class </font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor unav</font>
<font color="#0000ff">#          tsmmonitor unav 2 4</font>
<font color="#0000ff">#          tsmmonitor unav -d=LTOCLASS 2 4</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
unav <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> unav<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol devclass
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM volumes WHERE access='UNAVAILABLE'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -d=* | --deviceclass=* <font color="#804040"><b>)</b></font>
            <font color="#008080">devclass</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND devclass_name='</font><font color="#a020f0">$devclass</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">devclass</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in device class </font><font color="#a020f0">$devclass</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor unav: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select unav </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of unavailable volumes</font>
    <font color="#008080">num_vol</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$UNAV_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$UNAV_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho unav <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of unavailable volumes </font><font color="#a020f0">$devclass$num_vol</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check a storage pool utilization</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: STGPOOL_WARNING</font>
<font color="#0000ff">#    critical.: STGPOOL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor stgpool &lt;storage_pool_name&gt; [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor stgpool DISK_POOL</font>
<font color="#0000ff">#          tsmmonitor stgpool DISK_POOL 50 75</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
stgpool <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> stgpool<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output pct_utl
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT pct_utilized FROM stgpools WHERE stgpool_name='</font><font color="#a020f0">$1</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># The user must specify the storage pool</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>!</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor stgpool: You must specify a storage pool name.</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$3</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor stgpool: invalid option -- '</font><font color="#a020f0">$2</font><font color="#ff00ff">' or '</font><font color="#a020f0">$3</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select stgpool </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">pct_utl</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9]/s/[.,].*//p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_utl</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$STGPOOL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_utl</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">3</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$STGPOOL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho stgpool <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">utilization of storage pool </font><font color="#a020f0">$1</font><font color="#ff00ff"> </font><font color="#a020f0">$pct_utl</font><font color="#ff00ff">%, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check for volumes with write error and/or read error</font>
<font color="#0000ff"># </font>
<font color="#0000ff"># Default, search for volumes with write or read errors</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: VOLERR_WARNING</font>
<font color="#0000ff">#    critical.: VOLERR_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor volerr [options] [warning] [critical]</font>
<font color="#0000ff">#    -r, --read                   test only read errors</font>
<font color="#0000ff">#    -w, --write                  test only write errors</font>
<font color="#0000ff">#    -l, --library=LIBRARY_NAME   check only volumes in the library</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor volerr</font>
<font color="#0000ff">#          tsmmonitor volerr -r</font>
<font color="#0000ff">#          tsmmonitor volerr 3 5</font>
<font color="#0000ff">#          tsmmonitor volerr -l=LTOLIB</font>
<font color="#0000ff">#          tsmmonitor volerr -l=LTOLIB 3 5</font>
<font color="#0000ff">#          tsmmonitor volerr -w -l=LTOLIB 3 5</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
volerr <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> volerr<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol library
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql_vol_err</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">( WRITE_ERRORS&gt;0 OR READ_ERRORS&gt;0 )</font><font color="#804040"><b>'</b></font>
    local <font color="#008080">sql_lib</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">volume_name IN ( SELECT volume_name FROM libvolumes WHERE library_name=</font><font color="#804040"><b>'</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM volumes WHERE</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># parsing options</font>
    while <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>do</b></font>
        <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
            -r | --read        <font color="#804040"><b>)</b></font> <font color="#008080">sql_vol_err</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">READ_ERRORS&gt;0</font><font color="#804040"><b>'</b></font>  <font color="#804040"><b>;;</b></font>
            -w | --write       <font color="#804040"><b>)</b></font> <font color="#008080">sql_vol_err</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">WRITE_ERRORS&gt;0</font><font color="#804040"><b>'</b></font> <font color="#804040"><b>;;</b></font>
            -l=* | --library=* <font color="#804040"><b>)</b></font> <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>            <font color="#804040"><b>;;</b></font>
            *                  <font color="#804040"><b>)</b></font> <font color="#804040"><b>break</b></font>                        <font color="#804040"><b>;;</b></font>
        <font color="#804040"><b>esac</b></font>
        <font color="#804040"><b>shift</b></font>
    <font color="#804040"><b>done</b></font>

    <font color="#0000ff"># define the correct sql statement</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$library</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> </font><font color="#a020f0">$sql_vol_err</font><font color="#ff00ff"> AND </font><font color="#a020f0">$sql_lib</font><font color="#ff00ff">'</font><font color="#a020f0">$library</font><font color="#ff00ff">' )</font><font color="#804040"><b>&quot;</b></font>
        <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in library </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>else</b></font>
        <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> </font><font color="#a020f0">$sql_vol_err</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor volerr: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select volerr </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of volumes</font>
    <font color="#008080">num_vol</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># check the status</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$VOLERR_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$VOLERR_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho volerr <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of volumes </font><font color="#a020f0">${</font><font color="#a020f0">library</font><font color="#a020f0">}</font><font color="#ff00ff">with error </font><font color="#a020f0">$num_vol</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check for volumes with percentage reclaimable space greater than </font>
<font color="#0000ff"># </font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: VOLRECL_WARNING</font>
<font color="#0000ff">#    critical.: VOLRECL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor volreclaim [options] [warning] [critical]</font>
<font color="#0000ff">#    -r, --reclaim=PCT_RECLAIM    pct reclaimable space (default: 80 pct)</font>
<font color="#0000ff">#    -l, --library=LIBRARY_NAME   check only volumes in the library</font>
<font color="#0000ff">#    -s, --stgpool=STGPOOL_NAME   check only volumes in the storage pool</font>
<font color="#0000ff">#    -V, --verbose                list the volumes found</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor volreclaim</font>
<font color="#0000ff">#          tsmmonitor volreclaim -r</font>
<font color="#0000ff">#          tsmmonitor volreclaim 3 5</font>
<font color="#0000ff">#          tsmmonitor volreclaim -l=LTOLIB</font>
<font color="#0000ff">#          tsmmonitor volreclaim -l=LTOLIB 3 5</font>
<font color="#0000ff">#          tsmmonitor volreclaim -w -l=LTOLIB 3 5</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
volreclaim <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> volreclaim<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol library stgpool verbose
    local <font color="#008080">pct_reclaim</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">80</font><font color="#804040"><b>'</b></font>
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql_lib</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">volume_name IN ( SELECT volume_name FROM libvolumes WHERE library_name=</font><font color="#804040"><b>'</b></font>
    local <font color="#008080">sql_list</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">volume_name,stgpool_name,pct_reclaim,status</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM volumes WHERE</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># parsing options</font>
    while <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>do</b></font>
        <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
            -r=* | --reclaim=* <font color="#804040"><b>)</b></font> <font color="#008080">pct_reclaim</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>;;</b></font>
            -l=* | --library=* <font color="#804040"><b>)</b></font> <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>     <font color="#804040"><b>;;</b></font>
            -s=* | --stgpool=* <font color="#804040"><b>)</b></font> <font color="#008080">stgpool</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>     <font color="#804040"><b>;;</b></font>
            -V   | --verbose   <font color="#804040"><b>)</b></font> <font color="#008080">verbose</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font>           <font color="#804040"><b>;;</b></font>
            *                  <font color="#804040"><b>)</b></font> <font color="#804040"><b>break</b></font>                 <font color="#804040"><b>;;</b></font>
        <font color="#804040"><b>esac</b></font>
        <font color="#804040"><b>shift</b></font>
    <font color="#804040"><b>done</b></font>

    <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> pct_reclaim&gt;</font><font color="#a020f0">$pct_reclaim</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># stgpool was specified</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$stgpool</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND stgpool_name='</font><font color="#a020f0">$stgpool</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#008080">stgpool</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in stgpool </font><font color="#a020f0">$stgpool</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># library was specified</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$library</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND </font><font color="#a020f0">$sql_lib</font><font color="#ff00ff">'</font><font color="#a020f0">$library</font><font color="#ff00ff">' )</font><font color="#804040"><b>&quot;</b></font>
        <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in library </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># test the pct of reclaim</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$pct_reclaim</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor volreclaim: invalid percentage -- '</font><font color="#a020f0">$pct_reclaim</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor volreclaim: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select volreclaim </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># number of volumes</font>
    <font color="#008080">num_vol</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># check the status</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$VOLRECL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$VOLRECL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$verbose</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#008080">sql</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#a020f0">$sql</font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">s/count(\*)/</font><font color="#a020f0">$sql_list</font><font color="#ff00ff">/</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>
        _tsmmonitor_tool run_select volreclaim <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>|</b></font>
            sed <font color="#804040"><b>-n</b></font> <font color="#804040"><b>'</b></font><font color="#ff00ff">/ANS8000I/,/ANS8002I/p</font><font color="#804040"><b>'</b></font>
        <font color="#804040"><b>echo</b></font>
    <font color="#804040"><b>fi</b></font>

    _tsmmonitor_tool myecho volreclaim \
    <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of volumes pct.reclaim&gt;</font><font color="#a020f0">$pct_reclaim</font><font color="#ff00ff"> </font><font color="#a020f0">$stgpool$library$num_vol</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check how many tapes are in the library</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: TAPESLIB_WARNING</font>
<font color="#0000ff">#    critical.: TAPESLIB_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor tapeslib [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#    -l, --library=LIBRARY_NAME   check only volumes in the library</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor tapeslib</font>
<font color="#0000ff">#          tsmmonitor tapeslib 120 115</font>
<font color="#0000ff">#          tsmmonitor tapeslib -l=LTOLIB3 120 115</font>
<font color="#0000ff">#          tsmmonitor tapeslib -l=LTOLIB3</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
tapeslib <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> tapeslib<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_tapes library
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM libvolumes</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -l=* | --library=* <font color="#804040"><b>)</b></font>
            <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> WHERE library_name='</font><font color="#a020f0">$library</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor tapeslib: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select tapeslib </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of tapes</font>
    <font color="#008080">num_tapes</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9]/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_tapes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-le</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$TAPESLIB_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_tapes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-le</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$TAPESLIB_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho tapeslib <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of tapes in the library </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#a020f0">$num_tapes</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check how many tapes have a specific owner</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: TAPESOWN_WARNING</font>
<font color="#0000ff">#    critical.: TAPESOWN_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor tapesown &lt;owner&gt; [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor tapesown tsmsrv01</font>
<font color="#0000ff">#          tsmmonitor tapesown tsmsrv01 4 5</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
tapesown <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> tapesown<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_tapes
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM libvolumes WHERE owner='</font><font color="#a020f0">$1</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># User must specify an owner</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>!</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor tapesown: You must specify an owner</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$3</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor tapesown: invalid option -- '</font><font color="#a020f0">$2</font><font color="#ff00ff">' or '</font><font color="#a020f0">$3</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select tapesown </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of tapes</font>
    <font color="#008080">num_tapes</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9]/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_tapes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$TAPESOWN_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_tapes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">3</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$TAPESOWN_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho tapesown <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of tapes owner by </font><font color="#a020f0">$1</font><font color="#ff00ff"> </font><font color="#a020f0">$num_tapes</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check how many volumes are in a specific storage pool</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: TAPESSTGPOOL_WARNING</font>
<font color="#0000ff">#    critical.: TAPESSTGPOOL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor tapesstgpool &lt;storage_pool_name&gt; [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor tapesstgpool DAILY</font>
<font color="#0000ff">#          tsmmonitor tapesstgpool DAILY 30 45</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
tapesstgpool <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> tapesstgpool<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_tapes
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM volumes WHERE stgpool_name='</font><font color="#a020f0">$1</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># User must specify a storage pool</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>!</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor tapesstgpool: You must specify a storage pool</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$3</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor tapesstgpool: invalid option -- '</font><font color="#a020f0">$2</font><font color="#ff00ff">' or '</font><font color="#a020f0">$3</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select tapesstgpool </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of tapes in the storage pool</font>
    <font color="#008080">num_tapes</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9]/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_tapes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$TAPESSTGPOOL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_tapes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">3</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$TAPESSTGPOOL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho tapesstgpool <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of tapes in storage pool </font><font color="#a020f0">$1</font><font color="#ff00ff"> </font><font color="#a020f0">$num_tapes</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check how many tsm db backup there are in the last N hours (default is 25h)</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: DBBKP_WARNING</font>
<font color="#0000ff">#    critical.: DBBKP_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor dbbkp [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#    -t, --type=I,F,S       Specifies the type of backup to look for   </font>
<font color="#0000ff">#                           Incremental,Full,dbSnapshot (default is full only)</font>
<font color="#0000ff">#    -H, --hours=NUM_HOURS  how many hours ago to search for db backup</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor dbbkp</font>
<font color="#0000ff">#          tsmmonitor dbbkp 2 1</font>
<font color="#0000ff">#          tsmmonitor dbbkp -H=12</font>
<font color="#0000ff">#          tsmmonitor dbbkp -H=12 2 1</font>
<font color="#0000ff">#          tsmmonitor dbbkp -H=12 -t=S</font>
<font color="#0000ff">#          tsmmonitor dbbkp -H=12 -t=F,S 2 1</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
dbbkp <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> dbbkp<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_bkp
    local <font color="#008080">type</font>=F
    local <font color="#008080">hours</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">25</font><font color="#804040"><b>'</b></font>
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM volhistory WHERE </font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">opt_type</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">F\|S\|I\|F,S\|F,I\|S,F\|S,I\|I,F\|I,S\|F,S,I\|F,I,S\|S,F,I\|S,I,F\|I,F,S\|I,S,F</font><font color="#804040"><b>'</b></font>

    <font color="#0000ff"># parsing options</font>
    while <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>do</b></font>
        <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
            <font color="#0000ff"># how many hours ago</font>
            -H=* | --hours=* <font color="#804040"><b>)</b></font> <font color="#008080">hours</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>   <font color="#804040"><b>;;</b></font>
            <font color="#0000ff"># type of DB backup to look for</font>
            -t=* | --type=*  <font color="#804040"><b>)</b></font> <font color="#008080">type</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>   <font color="#804040"><b>;;</b></font>
            *                <font color="#804040"><b>)</b></font> <font color="#804040"><b>break</b></font>            <font color="#804040"><b>;;</b></font>
        <font color="#804040"><b>esac</b></font>
        <font color="#804040"><b>shift</b></font>
    <font color="#804040"><b>done</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$hours</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor dbbkp: invalid option </font><font color="#a020f0">$hours</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># is the type of db backup valid?</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#a020f0">$type</font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">s/^</font><font color="#a020f0">$opt_type</font><font color="#ff00ff">//</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor dbbkp: invalid db type '</font><font color="#a020f0">$type</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#008080">type</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#a020f0">$type</font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed </font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">    </font><font color="#ff00ff">                     s/F/type='BACKUPFULL'/</font>
<font color="#6a5acd">                        </font><font color="#ff00ff"> s/S/type='DBSNAPSHOT'/</font>
<font color="#6a5acd">                        </font><font color="#ff00ff"> s/I/type='DBINCREMENTAL'/</font>
<font color="#6a5acd">                        </font><font color="#ff00ff"> s/,/ OR /g</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> date_time&gt;=current_timestamp-</font><font color="#a020f0">$hours</font><font color="#ff00ff"> hours AND ( </font><font color="#a020f0">$type</font><font color="#ff00ff"> )</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor dbbkp: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select dbbkp </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of db backups</font>
    <font color="#008080">num_bkp</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_bkp</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-le</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DBBKP_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_bkp</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-le</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DBBKP_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho dbbkp <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of tsm db backup in the last </font><font color="#a020f0">${</font><font color="#a020f0">hours</font><font color="#a020f0">}</font><font color="#ff00ff">h </font><font color="#a020f0">$num_bkp</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of nodes sessions</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: NUMSESS_WARNING</font>
<font color="#0000ff">#    critical.: NUMSESS_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor numsess [options] [warning] [critical] [session_state]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#   -s, --state=SESSION_STATE   Count only nodes sessions with a specifc state</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor numsess</font>
<font color="#0000ff">#          tsmmonitor numsess 100 150</font>
<font color="#0000ff">#          tsmmonitor numsess -s=MediaW 5 10</font>
<font color="#0000ff">#          tsmmonitor numsess -s=MediaW</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
numsess <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> numsess<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_sess sess_state
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM sessions WHERE session_type='Node'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -s=* | --state=* <font color="#804040"><b>)</b></font>
            <font color="#008080">sess_state</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND state='</font><font color="#a020f0">$sess_state</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor numsess: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select numsess </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of nodes sessions</font>
    <font color="#008080">num_sess</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_sess</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$NUMSESS_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_sess</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$NUMSESS_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho numsess <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of nodes sessions </font><font color="#a020f0">$sess_state</font><font color="#ff00ff"> </font><font color="#a020f0">$num_sess</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of nodes</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: NUMNODES_WARNING</font>
<font color="#0000ff">#    critical.: NUMNODES_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor numnodes [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#    -d, --domain=DOMAIN  Count nodes only in the DOMAIN</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor numnodes</font>
<font color="#0000ff">#          tsmmonitor numnodes 20 30</font>
<font color="#0000ff">#          tsmmonitor numnodes -d=SAP 20 30</font>
<font color="#0000ff">#          tsmmonitor numnodes -d=SAP</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
numnodes <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> numnodes<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_nodes domain
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM nodes</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -d=* | --domain=* <font color="#804040"><b>)</b></font>
            <font color="#008080">domain</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> WHERE domain_name='</font><font color="#a020f0">$domain</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">domain</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in domain </font><font color="#a020f0">$domain</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor numnodes: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select numnodes </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of nodes</font>
    <font color="#008080">num_nodes</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">num_nodes</font><font color="#804040"><b>:-</b></font><span style="background-color: #ff0000"><font color="#ffffff">0</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$NUMNODES_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">num_nodes</font><font color="#804040"><b>:-</b></font><span style="background-color: #ff0000"><font color="#ffffff">0</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$NUMNODES_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho numnodes <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of nodes </font><font color="#a020f0">$domain</font><font color="#ff00ff"> </font><font color="#a020f0">${</font><font color="#a020f0">num_nodes</font><font color="#804040"><b>:-</b></font><span style="background-color: #ff0000"><font color="#ffffff">0</font></span><font color="#a020f0">}</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of nodes locked</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: NUMNODESLOCKED_WARNING</font>
<font color="#0000ff">#    critical.: NUMNODESLOCKED_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor nodeslocked [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#    -d, --domain=DOMAIN  Count nodes only in the DOMAIN</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor nodeslocked</font>
<font color="#0000ff">#          tsmmonitor nodeslocked 2 4</font>
<font color="#0000ff">#          tsmmonitor nodeslocked -d=SAP 2 4</font>
<font color="#0000ff">#          tsmmonitor nodeslocked -d=SAP</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
nodeslocked <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> nodeslocked<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_nodes domain
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM nodes WHERE locked='YES'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># options parser</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -d=* | --domain=* <font color="#804040"><b>)</b></font>
            <font color="#008080">domain</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND domain_name='</font><font color="#a020f0">$domain</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
            <font color="#008080">domain</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in domain </font><font color="#a020f0">$domain</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor numnodes: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select nodeslocked </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of nodes</font>
    <font color="#008080">num_nodes</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_nodes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$NUMNODESLOCKED_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_nodes</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$NUMNODESLOCKED_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho nodeslocked <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of nodes locked </font><font color="#a020f0">$domain</font><font color="#ff00ff"> </font><font color="#a020f0">$num_nodes</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of disk volumes without readwrite access</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: DISKVOL_WARNING</font>
<font color="#0000ff">#    critical.: DISKVOL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor diskvol [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor diskvol</font>
<font color="#0000ff">#          tsmmonitor diskvol 2 3</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
diskvol <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> diskvol<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol_error
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM volumes WHERE \</font>
<font color="#6a5acd">            </font><font color="#ff00ff">devclass_name='DISK' AND NOT access='READWRITE'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor diskvol: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select diskvol </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of disk volumes without readwrite</font>
    <font color="#008080">num_vol_error</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># Test the diskvol status check</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol_error</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DISKVOL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol_error</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DISKVOL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho diskvol <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of disk volumes without readwrite access </font><font color="#a020f0">$num_vol_error</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of database volumes not synchronized (copy status)</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: DBVOL_WARNING</font>
<font color="#0000ff">#    critical.: DBVOL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor dbvol [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor dbvol</font>
<font color="#0000ff">#          tsmmonitor dbvol 2 3</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
dbvol <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> dbvol<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol_error
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM dbvolumes WHERE ( \</font>
<font color="#6a5acd">        </font><font color="#ff00ff">NOT copy1_status='Synchronized' OR</font>
<font color="#6a5acd">        </font><font color="#ff00ff">NOT copy2_status='Synchronized' OR</font>
<font color="#6a5acd">        </font><font color="#ff00ff">NOT copy3_status='Synchronized' )</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor dbvol: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select dbvol </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of volumes not synchronized</font>
    <font color="#008080">num_vol_error</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># Test the dbvol status check</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol_error</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DBVOL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol_error</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DBVOL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho dbvol <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of db volumes not synchronized </font><font color="#a020f0">$num_vol_error</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of log volumes not synchronized (copy status)</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: LOGVOL_WARNING</font>
<font color="#0000ff">#    critical.: LOGVOL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor logvol [warning] [critical]</font>
<font color="#0000ff"># Example: tsmmonitor logvol</font>
<font color="#0000ff">#          tsmmonitor logvol 2 3</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
logvol <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font><font color="#804040"><b>&amp;&amp;</b></font><font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> logvol<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol_error
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM logvolumes WHERE (</font>
<font color="#6a5acd">            </font><font color="#ff00ff">NOT copy1_status='Synchronized' OR</font>
<font color="#6a5acd">            </font><font color="#ff00ff">NOT copy2_status='Synchronized' OR </font>
<font color="#6a5acd">            </font><font color="#ff00ff">NOT copy3_status='Synchronized' )</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor logvol: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select logvol </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of volumes not synchronized</font>
    <font color="#008080">num_vol_error</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#0000ff"># Test de logvol status check</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol_error</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$LOGVOL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol_error</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$LOGVOL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho logvol <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of log volumes not synchronized </font><font color="#a020f0">$num_vol_error</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># Search for a specific ANR in the last N hours (default is 1h)</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: SEARCHANR_WARNING</font>
<font color="#0000ff">#    critical.: SEARCHANR_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor searchanr [options] &lt;ANR&gt; [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#    -H, --hours=NUM_HOURS_AGO   how many hours ago to search for</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor searchanr ANR8446W</font>
<font color="#0000ff">#          tsmmonitor searchanr ANR8446W 2 4</font>
<font color="#0000ff">#          tsmmonitor searchanr -H=12 ANR8446W</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
searchanr <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> searchanr<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_msg
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">hours</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font>
    <font color="#0000ff"># </font><span style="background-color: #ffff00"><font color="#0000ff">XXX</font></span><font color="#0000ff">: change to q aclot (faster)</font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM actlog WHERE</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># parsing options</font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        <font color="#0000ff"># How many hours ago to search for</font>
        -H=* | --hours=* <font color="#804040"><b>)</b></font>
            <font color="#008080">hours</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>shift</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$hours</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor searchanr: invalid option '</font><font color="#a020f0">$hours</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># The user must specify the ANR</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>!</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor searchanr: You must specify a ANR.</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> message LIKE'</font><font color="#a020f0">$1</font><font color="#ff00ff">%' AND date_time&gt;=current_timestamp-</font><font color="#a020f0">$hours</font><font color="#ff00ff"> hours</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$3</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor searchanr: invalid option -- '</font><font color="#a020f0">$2</font><font color="#ff00ff">' or '</font><font color="#a020f0">$3</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select searchanr </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of messages</font>
    <font color="#008080">num_msg</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_msg</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$SEARCHANR_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_msg</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">3</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$SEARCHANR_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># Print the script output and exit with the right return code</font>
    _tsmmonitor_tool myecho searchanr <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of messages with </font><font color="#a020f0">$1</font><font color="#ff00ff"> in the last </font><font color="#a020f0">${</font><font color="#a020f0">hours</font><font color="#a020f0">}</font><font color="#ff00ff">h </font><font color="#a020f0">$num_msg</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check number of DRM volumes</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default values are:</font>
<font color="#0000ff">#    warning..: DRMVOL_WARNING</font>
<font color="#0000ff">#    critical.: DRMVOL_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor drmvol [options] [warning] [critical]</font>
<font color="#0000ff">#</font>
<font color="#0000ff">#  -l, --library=LIBRARY_NAME  search volumes only in the library</font>
<font color="#0000ff">#  -s, --state=DRM_STATE       DRM state of volumes (default: MOUNTABLE)</font>
<font color="#0000ff">#                              VAULT,VAULTRETRIEVE,COURIERRETRIEVE</font>
<font color="#0000ff">#  -i, --invert                Invert the sense of matching, to select</font>
<font color="#0000ff">#                              non-matching volumes</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor drmvol</font>
<font color="#0000ff">#          tsmmonitor drmvol -i -l=3584LIB # DRM volumes with state different from MOUNTABLE in library</font>
<font color="#0000ff">#          tsmmonitor drmvol -s=COURIERRETRIEVE</font>
<font color="#0000ff">#          tsmmonitor drmvol -s=VAULT -l=3584LIB 1 8</font>
<font color="#0000ff">#          tsmmonitor drmvol 2 6</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
drmvol <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> drmvol<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_vol library
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">state</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">MOUNTABLE</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">type_match</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">=</font><font color="#804040"><b>'</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM drmedia WHERE</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql_in_lib</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">AND volume_name IN ( SELECT volume_name FROM libvolumes WHERE</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># parsing options</font>
    while <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>do</b></font>
        <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
            -s=* | --state=*   <font color="#804040"><b>)</b></font> <font color="#008080">state</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>   <font color="#804040"><b>;;</b></font>
            -l=* | --library=* <font color="#804040"><b>)</b></font> <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>;;</b></font>
            -i   | --invert    <font color="#804040"><b>)</b></font> <font color="#008080">type_match</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">&lt;&gt;</font><font color="#804040"><b>'</b></font>   <font color="#804040"><b>;;</b></font>
        <font color="#804040"><b>esac</b></font>
        <font color="#804040"><b>shift</b></font>
    <font color="#804040"><b>done</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$library</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> state</font><font color="#a020f0">$type_match</font><font color="#ff00ff">'</font><font color="#a020f0">$state</font><font color="#ff00ff">' </font><font color="#a020f0">$sql_in_lib</font><font color="#ff00ff"> library_name='</font><font color="#a020f0">$library</font><font color="#ff00ff">' )</font><font color="#804040"><b>&quot;</b></font>
        <font color="#008080">library</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">in library </font><font color="#a020f0">$library</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>else</b></font>
        <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> state</font><font color="#a020f0">$type_match</font><font color="#ff00ff">'</font><font color="#a020f0">$state</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor drmvol: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select drmvol </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#008080">num_vol</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9]\{1,\}$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DRMVOL_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_vol</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$DRMVOL_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$type_match</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>'</b></font><font color="#ff00ff">=</font><font color="#804040"><b>'</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        _tsmmonitor_tool myecho drmvol \
        <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of DRM volumes with state </font><font color="#a020f0">$state</font><font color="#ff00ff"> </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#a020f0">$num_vol</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>else</b></font>
        _tsmmonitor_tool myecho drmvol \
        <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of DRM volumes different from </font><font color="#a020f0">$state</font><font color="#ff00ff"> </font><font color="#a020f0">$library</font><font color="#ff00ff"> </font><font color="#a020f0">$num_vol</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check the number of schedules not completed (only today's schedules)</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># The default numbers are:</font>
<font color="#0000ff">#    warning..: SCHED_WARNING</font>
<font color="#0000ff">#    critical.: SCHED_CRITICAL</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor sched [options] [warning] [critical]</font>
<font color="#0000ff">#     -a, --admin                   only administrative schedules.</font>
<font color="#0000ff">#     -s, --schedule=SCHEDULE_NAME  only a specific schedule</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Example: tsmmonitor sched</font>
<font color="#0000ff">#          tsmmonitor sched -a</font>
<font color="#0000ff">#          tsmmonitor sched -s=DAILY_BKP 4 15</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
sched <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> sched<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output num_sched
    local <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">OK</font><font color="#804040"><b>&quot;</b></font>
    local <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">SELECT count(*) FROM events WHERE status&lt;&gt;'Completed' AND status&lt;&gt;'Future' AND status&lt;&gt;'Started'</font><font color="#804040"><b>&quot;</b></font>

    <font color="#0000ff"># parsing options</font>
    while <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>do</b></font>
        <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
            -a   | --admin      <font color="#804040"><b>)</b></font> <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND domain_name IS null</font><font color="#804040"><b>&quot;</b></font>     <font color="#804040"><b>;;</b></font>
            -s=* | --schedule=* <font color="#804040"><b>)</b></font> <font color="#008080">sql</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#ff00ff"> AND schedule_name='</font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>;;</b></font>
            *                   <font color="#804040"><b>)</b></font> <font color="#804040"><b>break</b></font>                                  <font color="#804040"><b>;;</b></font>
        <font color="#804040"><b>esac</b></font>
        <font color="#804040"><b>shift</b></font>
    <font color="#804040"><b>done</b></font>

    <font color="#0000ff"># Test if the parameters are numbers</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>!</b></font> _tsmmonitor_tool is_number <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>then</b></font>
        <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Error: tsmmonitor sched: invalid option -- '</font><font color="#a020f0">$1</font><font color="#ff00ff">' or '</font><font color="#a020f0">$2</font><font color="#ff00ff">'</font><font color="#804040"><b>&quot;</b></font>
        <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>
    <font color="#804040"><b>fi</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select sched </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Number of failed schedules</font>
    <font color="#008080">num_sched</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed -n </font><font color="#804040"><b>'</b></font><font color="#ff00ff">/^[0-9][0-9]*$/p</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_sched</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$SCHED_WARNING</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Warning</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$num_sched</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-ge</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">2</font><font color="#804040"><b>:-</b></font><font color="#a020f0">$SCHED_CRITICAL</font><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#008080">status</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Critical</font><font color="#804040"><b>&quot;</b></font>

    _tsmmonitor_tool myecho sched <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">number of schedules not completed </font><font color="#a020f0">$num_sched</font><font color="#ff00ff">, </font><font color="#a020f0">$status</font><font color="#804040"><b>&quot;</b></font>
<font color="#6a5acd">}</font>

<font color="#0000ff"># ----------------------------------------------------------------------------</font>
<font color="#0000ff"># check server license compliance</font>
<font color="#0000ff">#</font>
<font color="#0000ff"># Usage..: tsmmonitor lic</font>
<font color="#0000ff"># Example: tsmmonitor lic</font>
<font color="#0000ff"># ----------------------------------------------------------------------------</font>
lic <font color="#804040"><b>()</b></font>
<font color="#6a5acd">{</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">--help</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>-o</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-h</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> <font color="#6a5acd">{</font> _ShowHelp <font color="#a020f0">$0</font> lic<font color="#804040"><b>;</b></font> <font color="#804040"><b>return</b></font><font color="#804040"><b>;</b></font> <font color="#6a5acd">}</font>

    local tsm_output lic_status
    local <font color="#008080">sql</font>=<font color="#804040"><b>'</b></font><font color="#ff00ff">SELECT compliance FROM licenses</font><font color="#804040"><b>'</b></font>

    <font color="#0000ff"># Run the select statement</font>
    <font color="#008080">tsm_output</font>=<font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">_tsmmonitor_tool run_select lic </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$sql</font><font color="#804040"><b>&quot;</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>exit</b></font> <font color="#ff00ff">3</font>

    <font color="#0000ff"># Get the license status</font>
    <font color="#008080">lic_status</font>=<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span>
<font color="#6a5acd">        echo </font><font color="#804040"><b>&quot;</b></font><font color="#a020f0">$tsm_output</font><font color="#804040"><b>&quot;</b></font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font>
<font color="#6a5acd">            sed -n </font><font color="#804040"><b>'</b></font>
<font color="#6a5acd">                </font><font color="#ff00ff">/^ANS8000I/{</font>
<font color="#6a5acd">                    </font><font color="#ff00ff">n</font>
<font color="#6a5acd">                    </font><font color="#ff00ff">p</font>
<font color="#6a5acd">                </font><font color="#ff00ff">}</font><font color="#804040"><b>'</b></font>
<font color="#6a5acd">    </font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>
    <font color="#0000ff"># Check if status is valid</font>
    <font color="#804040"><b>if</b></font> <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$lic_status</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Valid</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font>
    <font color="#804040"><b>then</b></font>
        _tsmmonitor_tool myecho lic <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Valid Server License Compliance, OK</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>else</b></font>
        _tsmmonitor_tool myecho lic <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">Failed Server License Compliance, Critical</font><font color="#804040"><b>&quot;</b></font>
    <font color="#804040"><b>fi</b></font>
<font color="#6a5acd">}</font>


<font color="#0000ff">##############################################################################</font>
<font color="#0000ff">################################### Main #####################################</font>
<font color="#0000ff">##############################################################################</font>

<font color="#0000ff"># parsing global options</font>
<font color="#804040"><b>while</b></font><font color="#804040"><b> </b></font><font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>!=</b></font> <font color="#804040"><b>&quot;&quot;</b></font> <font color="#804040"><b>]</b></font>
<font color="#804040"><b>do</b></font>
    <font color="#804040"><b>case</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>in</b></font>
        -h   | --help         <font color="#804040"><b>)</b></font> _tsmmonitor_tool program_help     <font color="#804040"><b>;;</b></font>
        -V   | --version      <font color="#804040"><b>)</b></font> _tsmmonitor_tool program_version  <font color="#804040"><b>;;</b></font>
        -s=* | --servername=* <font color="#804040"><b>)</b></font> <font color="#008080">SERVERNAME</font>=<font color="#804040"><b>&quot;</b></font><font color="#ff00ff">-servername=</font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>  <font color="#804040"><b>;;</b></font>
        -u=* | --user=*       <font color="#804040"><b>)</b></font> <font color="#008080">USER</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>                    <font color="#804040"><b>;;</b></font>
        -p=* | --pass=*       <font color="#804040"><b>)</b></font> <font color="#008080">PASS</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>                    <font color="#804040"><b>;;</b></font>
        -m=* | --mail=*       <font color="#804040"><b>)</b></font> <font color="#008080">MAILTO</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">${</font><font color="#a020f0">1</font><span style="background-color: #ff0000"><font color="#ffffff">#*=</font></span><font color="#a020f0">}</font><font color="#804040"><b>&quot;</b></font>                  <font color="#804040"><b>;;</b></font>
        -S   | --source       <font color="#804040"><b>)</b></font> <font color="#008080">SHOW_CHECK_SOURCE</font>=<font color="#ff00ff">1</font>               <font color="#804040"><b>;;</b></font>
        -d   | --debug        <font color="#804040"><b>)</b></font> <font color="#008080">DEBUG</font>=<font color="#ff00ff">1</font>                           <font color="#804040"><b>;;</b></font>
        -q   | --quiet        <font color="#804040"><b>)</b></font> <font color="#008080">QUIET</font>=<font color="#ff00ff">1</font>                           <font color="#804040"><b>;;</b></font>
        <font color="#0000ff"># probably, $1 has the function (check)</font>
        * <font color="#804040"><b>)</b></font>
            <font color="#008080">func</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$1</font><font color="#804040"><b>&quot;</b></font>
            <font color="#0000ff"># tsm base query command. usually, you do not need to touch here</font>
            <font color="#008080">TSM_CMD</font>=<font color="#804040"><b>&quot;</b></font><font color="#a020f0">$DSMADMC</font><font color="#ff00ff"> </font><font color="#a020f0">$SERVERNAME</font><font color="#ff00ff"> -tab -id=</font><font color="#a020f0">$USER</font><font color="#ff00ff"> -password=</font><font color="#a020f0">$PASS</font><font color="#804040"><b>&quot;</b></font>

            _Debug <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">TSM_CMD = </font><font color="#a020f0">$TSM_CMD</font><font color="#804040"><b>&quot;</b></font>
            _Debug <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">MAILTO = </font><font color="#a020f0">$MAILTO</font><font color="#804040"><b>&quot;</b></font>

            <font color="#0000ff"># is there the function?</font>
            <font color="#804040"><b>if</b></font> type <font color="#a020f0">$func</font> <font color="#804040"><b>&gt;</b></font> /dev/null <font color="#804040"><b>2&gt;</b></font> /dev/null
            <font color="#804040"><b>then</b></font>
                <font color="#0000ff"># print the function (check) source code only</font>
                <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$SHOW_CHECK_SOURCE</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>=</b></font> <font color="#804040"><b>&quot;</b></font><font color="#ff00ff">1</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>&amp;&amp;</b></font> _tsmmonitor_tool mysource <font color="#a020f0">$func</font>

                <font color="#804040"><b>shift</b></font>
                <font color="#0000ff"># file to record check status</font>
                <font color="#008080">StatusFile</font>=<font color="#a020f0">${</font><font color="#a020f0">func</font><font color="#a020f0">}</font>_<span style="background-color: #ff0000"><font color="#ffffff">$(</font></span><font color="#6a5acd">echo </font><font color="#a020f0">$*</font><font color="#6a5acd"> </font><font color="#804040"><b>|</b></font><font color="#6a5acd"> sed </font><font color="#804040"><b>'</b></font><font color="#ff00ff">s/ /_/g</font><font color="#804040"><b>'</b></font><span style="background-color: #ff0000"><font color="#ffffff">)</font></span>

                <font color="#0000ff"># execute the check ($func) function</font>
                <font color="#a020f0">$func</font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$@</font><font color="#804040"><b>&quot;</b></font>
            <font color="#804040"><b>else</b></font>
                <font color="#804040"><b>echo</b></font><font color="#ff00ff"> </font><font color="#804040"><b>&quot;</b></font><font color="#ff00ff">tsmmonitor: check '</font><font color="#a020f0">$func</font><font color="#ff00ff">' not found (try --help)</font><font color="#804040"><b>&quot;</b></font>
                <font color="#804040"><b>exit</b></font> <font color="#ff00ff">1</font>
            <font color="#804040"><b>fi</b></font>
        <font color="#804040"><b>;;</b></font>
    <font color="#804040"><b>esac</b></font>

    <font color="#0000ff"># In some sh implementation, if there is no more option we get the error</font>
    <font color="#0000ff"># error: shift: bad number</font>
    <font color="#804040"><b>[</b></font> <font color="#804040"><b>&quot;</b></font><font color="#a020f0">$2</font><font color="#804040"><b>&quot;</b></font> <font color="#804040"><b>!=</b></font> <font color="#804040"><b>&quot;&quot;</b></font> <font color="#804040"><b>]</b></font> <font color="#804040"><b>||</b></font> <font color="#804040"><b>break</b></font>

    <font color="#804040"><b>shift</b></font>
<font color="#804040"><b>done</b></font>

<font color="#804040"><b>exit</b></font> <font color="#ff00ff">0</font>

<font color="#0000ff"># vim: ts=4</font>
</pre>
</body>
</html>
